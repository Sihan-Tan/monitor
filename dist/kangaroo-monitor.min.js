!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).KangarooMonitor={})}(this,(function(e){"use strict";
/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)};function n(e,n){function o(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(o.prototype=n.prototype,new o)}var o=function(){return(o=Object.assign||function(e){for(var t,n=1,o=arguments.length;o>n;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e}).apply(this,arguments)};function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var i,a,c,s,u=function(){function e(e){this.options=e}return e.prototype.send=function(e){var t=this.options,n=t.logUrl,i=t.apiKey,a=t.debug,c=t.probability;if(!n||!i)return!1;var s=o({apiKey:i},e);if(Math.random()<(10-(c||5))/10)return!1;a&&console.log(e);var u,d,l=(u=[],d=JSON.stringify(s,(function(e,t){if("object"===r(t)&&null!==t){if(-1!==u.indexOf(t))try{return JSON.parse(JSON.stringify(t))}catch(e){return}u.push(t)}return t})),u=null,d);navigator.sendBeacon?navigator.sendBeacon(n,l):setTimeout((function(){a&&console.info("传输数据📚🍊: ",n,s),"fetch"in window?fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:l,keepalive:!0}):console.log("%ckangaroo monitor 暂时只支持navigator.sendBean | fetch Api","color:#FFA138;font-size:16px;")}))},e}(),d=function(e,t){return{name:e,value:void 0===t?-1:0,delta:0,entries:[],id:"v1-".concat(Date.now(),"-").concat(Math.floor(8999999999999*Math.random())+1e12)}},l=function(e,t){try{if(PerformanceObserver.supportedEntryTypes.includes(e)){var n=new PerformanceObserver((function(e){return e.getEntries().map(t)}));return n.observe({type:e,buffered:!0}),n}}catch(e){}},p=!1,f=function(e,t){p||"undefined"!=typeof InstallTrigger||(addEventListener("beforeunload",(function(){})),p=!0),addEventListener("visibilitychange",(function n(o){"hidden"===document.visibilityState&&(e(o),t&&removeEventListener("visibilitychange",n,!0))}),!0)},m=function(e){addEventListener("pageshow",(function(t){t.persisted&&e(t)}),!0)},v=new WeakSet,y=function(e,t,n){var o;return function(){t.value>=0&&(n||v.has(t)||"hidden"===document.visibilityState)&&(t.delta=t.value-(o||0),(t.delta||void 0===o)&&(o=t.value,e(t)))}},h=-1,g=function(){return"hidden"===document.visibilityState?0:1/0},w=function(){f((function(e){h=e.timeStamp}),!0)},S=function(){return 0>h&&(h=g(),w(),m((function(){setTimeout((function(){h=g(),w()}),0)}))),{get timeStamp(){return h}}},E={passive:!0,capture:!0},b=new Date,T=function(e,t){i||(i=t,a=e,c=new Date,k(removeEventListener),L())},L=function(){if(a>=0&&c-b>a){var e={entryType:"first-input",name:i.type,target:i.target,cancelable:i.cancelable,startTime:i.timeStamp,processingStart:i.timeStamp+a};s.map((function(t){t(e)})),s=[]}},C=function(e){if(e.cancelable){var t=(e.timeStamp>1e12?new Date:performance.now())-e.timeStamp;"pointerdown"==e.type?function(e,t){var n=function(){T(e,t),r()},o=function(){r()},r=function(){removeEventListener("pointerup",n,E),removeEventListener("pointercancel",o,E)};addEventListener("pointerup",n,E),addEventListener("pointercancel",o,E)}(t,e):T(t,e)}},k=function(e){["mousedown","keydown","touchstart","pointerdown"].map((function(t){return e(t,C,E)}))},_=function(e){function t(t){var n=e.call(this,t)||this;return n.isResource=t.isResource,n.syncCollect(),n.asyncCollect(),n}return n(t,e),t.prototype.syncCollect=function(){this.performanceTime(),this.isResource&&this.performanceResource()},t.prototype.asyncCollect=function(){this.performancePaint()},t.prototype.performanceTime=function(){var e=performance.timing;if(e){var t={type:"timing",data:this.formatTime(e,performance)};this.send(t)}else this.send({type:"timing",data:"performance Api 暂不支持"})},t.prototype.performanceResource=function(){for(var e=[],t=0,n=performance.getEntriesByType("resource");n.length>t;t++){e.push(n[t])}this.send({type:"resource",data:e})},t.prototype.performancePaint=function(){var e=this;function t(t){e.send({type:"performance",data:t})}!function(e,t){var n,o=d("CLS",0),r=function(e){e.hadRecentInput||(o.value+=e.value,o.entries.push(e),n())},i=l("layout-shift",r);i&&(n=y(e,o,t),f((function(){i.takeRecords().map(r),n()})),m((function(){o=d("CLS",0),n=y(e,o,t)})))}(t),function(e,t){var n,o=S(),r=d("FCP"),i=l("paint",(function(e){"first-contentful-paint"===e.name&&(i&&i.disconnect(),o.timeStamp>e.startTime&&(r.value=e.startTime,r.entries.push(e),v.add(r),n()))}));i&&(n=y(e,r,t),m((function(o){r=d("FCP"),n=y(e,r,t),requestAnimationFrame((function(){requestAnimationFrame((function(){r.value=performance.now()-o.timeStamp,v.add(r),n()}))}))})))}(t),function(e,t){var n,o=S(),r=d("FID"),c=function(e){o.timeStamp>e.startTime&&(r.value=e.processingStart-e.startTime,r.entries.push(e),v.add(r),n())},u=l("first-input",c);n=y(e,r,t),u&&f((function(){u.takeRecords().map(c),u.disconnect()}),!0),u&&m((function(){r=d("FID"),n=y(e,r,t),s=[],a=-1,i=null,k(addEventListener),s.push(c),L()}))}(t),function(e,t){var n,o=S(),r=d("LCP"),i=function(e){var t=e.startTime;o.timeStamp>t&&(r.value=t,r.entries.push(e)),n()},a=l("largest-contentful-paint",i);if(a){n=y(e,r,t);var c=function(){v.has(r)||(a.takeRecords().map(i),a.disconnect(),v.add(r),n())};["keydown","click"].map((function(e){addEventListener(e,c,{once:!0,capture:!0})})),f(c,!0),m((function(o){r=d("LCP"),n=y(e,r,t),requestAnimationFrame((function(){requestAnimationFrame((function(){r.value=performance.now()-o.timeStamp,v.add(r),n()}))}))}))}}(t),function(e){var t,n=d("TTFB");t=function(){try{var t=performance.getEntriesByType("navigation")[0]||function(){var e=performance.timing,t={entryType:"navigation",startTime:0};for(var n in e)"navigationStart"!==n&&"toJSON"!==n&&(t[n]=Math.max(e[n]-e.navigationStart,0));return t}();n.value=n.delta=t.responseStart,n.entries=[t],e(n)}catch(e){}},"complete"===document.readyState?setTimeout(t,0):addEventListener("pageshow",t)}(t)},t.prototype.formatTime=function(e,t){return{redirectCount:t.navigation.redirectCount,redirectTime:e.redirectEnd-e.redirectStart||0,dnsTime:e.domainLookupEnd-e.domainLookupStart,tcpTime:e.connectEnd-e.connectStart||0,sslTime:e.connectEnd-e.connectStart||0,ttfbTime:e.responseStart-e.requestStart||0,dataTime:e.responseEnd-e.responseStart||0,domAnalyzeTime:e.domInteractive-e.responseEnd||0,resourceTime:e.loadEventStart-e.domContentLoadedEventEnd,whiteTime:e.responseEnd-e.navigationStart||0,reactiveTime:e.domInteractive-e.navigationStart||0,domRenderedTime:e.domContentLoadedEventEnd-e.navigationStart||0,readyTime:e.domContentLoadedEventEnd-e.navigationStart||0,pageLoadedTime:e.loadEventEnd-e.navigationStart||0,pageAnalyzeDomTime:e.domComplete-e.domInteractive||0,unloadTime:e.unloadEventEnd-e.unloadEventStart||0}},t}(u),O=function(e){function t(t){var n=e.call(this,t)||this;return n._onerror(),n._eventListenerError(),n._unhandleRejection(),n}return n(t,e),t.prototype._onerror=function(){var e=this;window.onerror=function(t,n,o,r,i){var a,c,s,u={};return r=r||(null===(a=null===window||void 0===window?void 0:window.event)||void 0===a?void 0:a.colno)||1,o=o||(null===(c=null===window||void 0===window?void 0:window.event)||void 0===c?void 0:c.lineno)||1,u.msg=i&&i.stack?""+i.stack:t,u.type="error",u.title=document.title,u.curUrl=null===(s=null===window||void 0===window?void 0:window.location)||void 0===s?void 0:s.href,u.data={resourceUrl:n,line:o,col:r},e.send(u),!0}},t.prototype._eventListenerError=function(){var e=this;window.addEventListener("error",(function(t){var n;console.log("_eventListenerError",t);var o={},r=t.target||t.srcElement;o.note="resource",o.time=(new Date).getTime(),o.msg=t.message||(null==r?void 0:r.localName)+" is load error",o.type="error",o.title=document.title,o.curUrl=null===(n=null===window||void 0===window?void 0:window.location)||void 0===n?void 0:n.href,o.data={target:r.localName,type:t.type,resourceUrl:r.href||r.currentSrc||r.outerHTML},o.data.target&&e.send(o)}),!0)},t.prototype._unhandleRejection=function(){var e=this;window.addEventListener("unhandledrejection",(function(t){var n,o;console.log("_unhandleRejection",t);var i=t&&t.reason;if("object"!==r(i))return e.send({type:"error",msg:i,title:document.title,curUrl:null===(n=null===window||void 0===window?void 0:window.location)||void 0===n?void 0:n.href,data:{type:t.type}}),t.preventDefault(),!0;var a,c,s,u=i&&i.message||"",d=(i&&i.stack||"").match(/\(.+?\)/);d&&d.length&&(d=d[0]),(d=(d=d.replace(/\w.+[js|html]/g,(function(e){return a=e,""}))).split(":"))&&d.length>1&&(s=Number.parseInt(d[1]||0),c=Number.parseInt(d[2]||0));var l={};return l.time=(new Date).getTime(),l.msg=u,l.type="error",l.title=document.title,l.curUrl=null===(o=null===window||void 0===window?void 0:window.location)||void 0===o?void 0:o.href,l.data={resourceUrl:a,line:s,col:c},e.send(l),t.preventDefault(),!0}))},t}(u);function j(){return(65536*(1+Math.random())|0).toString(16).substring(1)}var I=function(){function e(e){this.options=o({debug:!0,isError:!0,isPage:!0,isResource:!0,probability:5,isCrash:!0},e),this.errInstance={}}return e.prototype.run=function(){var e=this.options,t=e.isError,n=e.isCrash;e.isPage&&new _(this.options),t&&(this.errInstance=new O(this.options)),n&&this.checkCrash()},e.prototype.report=function(e){console.log("report: ",e),this.errInstance.send({type:"error",data:e})},e.prototype.checkCrash=function(){var e=this;console.log("registerServiceWork");var t=j()+"-"+j()+"-"+j()+"-"+j()+j();console.log(t),window.addEventListener("load",(function(){var n=localStorage.getItem("crash");n&&e.report({type:"error",data:n}),localStorage.setItem("crash",t)})),window.addEventListener("beforeunload",(function(){localStorage.setItem("crash","")}))},e}();e.init=function(e){if(void 0===e&&(e={}),console.log("%ckangaroo monitor version: 0.0.1","color:#FFA138;font-size:16px;"),!e.disabled)if(e.logUrl){if(e.apiKey){var t=new I(e);return t.run(),t}console.error("请输入apiKey参数")}else console.error("请输入正确的log地址参数")},Object.defineProperty(e,"__esModule",{value:!0})}));
